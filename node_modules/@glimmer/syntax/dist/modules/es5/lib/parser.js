var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

import { EventedTokenizer, EntityParser, HTML5NamedCharRefs as namedCharRefs } from "simple-html-tokenizer";
import { assert } from '@glimmer/util';
var entityParser = new EntityParser(namedCharRefs);
export var Parser = function () {
    function Parser(source) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        _classCallCheck(this, Parser);

        this.elementStack = [];
        this.currentAttribute = null;
        this.currentNode = null;
        this.tokenizer = new EventedTokenizer(this, entityParser);
        this.options = options;
        this.tokenizer['states'].tagOpen = function () {
            var char = this.consume();
            if (char === "!") {
                this.state = 'markupDeclaration';
            } else if (char === "/") {
                this.state = 'endTagOpen';
            } else if (/[A-Za-z]/.test(char)) {
                this.state = 'tagName';
                this.delegate.beginStartTag();
                this.delegate.appendToTagName(char);
            }
        };
        this.tokenizer['states'].endTagOpen = function () {
            var char = this.consume();
            if (/[A-Za-z]/.test(char)) {
                this.state = 'tagName';
                this.delegate.beginEndTag();
                this.delegate.appendToTagName(char);
            }
        };
        this.source = source.split(/(?:\r\n?|\n)/g);
    }

    Parser.prototype.acceptNode = function acceptNode(node) {
        return this[node.type](node);
    };

    Parser.prototype.currentElement = function currentElement() {
        return this.elementStack[this.elementStack.length - 1];
    };

    Parser.prototype.sourceForNode = function sourceForNode(node, endNode) {
        var firstLine = node.loc.start.line - 1;
        var currentLine = firstLine - 1;
        var firstColumn = node.loc.start.column;
        var string = [];
        var line = void 0;
        var lastLine = void 0;
        var lastColumn = void 0;
        if (endNode) {
            lastLine = endNode.loc.end.line - 1;
            lastColumn = endNode.loc.end.column;
        } else {
            lastLine = node.loc.end.line - 1;
            lastColumn = node.loc.end.column;
        }
        while (currentLine < lastLine) {
            currentLine++;
            line = this.source[currentLine];
            if (currentLine === firstLine) {
                if (firstLine === lastLine) {
                    string.push(line.slice(firstColumn, lastColumn));
                } else {
                    string.push(line.slice(firstColumn));
                }
            } else if (currentLine === lastLine) {
                string.push(line.slice(0, lastColumn));
            } else {
                string.push(line);
            }
        }
        return string.join('\n');
    };

    _createClass(Parser, [{
        key: 'currentAttr',
        get: function get() {
            return this.currentAttribute;
        }
    }, {
        key: 'currentTag',
        get: function get() {
            var node = this.currentNode;
            assert(node && (node.type === 'StartTag' || node.type === 'EndTag'), 'expected tag');
            return node;
        }
    }, {
        key: 'currentStartTag',
        get: function get() {
            var node = this.currentNode;
            assert(node && node.type === 'StartTag', 'expected start tag');
            return node;
        }
    }, {
        key: 'currentEndTag',
        get: function get() {
            var node = this.currentNode;
            assert(node && node.type === 'EndTag', 'expected end tag');
            return node;
        }
    }, {
        key: 'currentComment',
        get: function get() {
            var node = this.currentNode;
            assert(node && node.type === 'CommentStatement', 'expected a comment');
            return node;
        }
    }, {
        key: 'currentData',
        get: function get() {
            var node = this.currentNode;
            assert(node && node.type === 'TextNode', 'expected a text node');
            return node;
        }
    }]);

    return Parser;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLEFBQU8sU0FDTCxBQUFnQixrQkFDaEIsQUFBWSxjQUNaLEFBQWtCLHNCQUFJLEFBQWEsQUFDcEMscUJBQU0sQUFBdUIsQUFBQztBQUsvQixBQUFPLFNBQUUsQUFBTSxBQUFFLEFBQU0sQUFBRSxjQUFNLEFBQWUsQUFBQztBQUUvQyxJQUFNLEFBQVksZUFBRyxJQUFJLEFBQVksYUFBQyxBQUFhLEFBQUMsQUFBQztBQXdCckQsQUFBTSxXQVFKO29CQUFZLEFBQWM7QUFQaEIsWUFPa0IsOEVBQWtCLEFBQUU7Ozs7YUFQMUIsZUFBYyxBQUFFLEFBQUMsQUFHaEM7YUFBZ0IsbUJBQXNCLEFBQUksQUFBQyxBQUMzQzthQUFXLGNBQTZFLEFBQUksQUFBQyxBQUM3RjthQUFTLFlBQUcsSUFBSSxBQUFnQixpQkFBQyxBQUFJLE1BQUUsQUFBWSxBQUFDLEFBQUMsQUFHMUQsQUFBSTthQUFDLEFBQU8sVUFBRyxBQUFPLEFBQUMsQUFFdkIsQUFBSTthQUFDLEFBQVMsVUFBQyxBQUFRLEFBQUMsVUFBQyxBQUFPLFVBQUcsWUFDakM7Z0JBQUksQUFBSSxPQUFHLEFBQUksS0FBQyxBQUFPLEFBQUUsQUFBQyxBQUMxQixBQUFFLEFBQUM7Z0JBQUMsQUFBSSxTQUFLLEFBQUcsQUFBQyxLQUFDLEFBQUMsQUFDakIsQUFBSTtxQkFBQyxBQUFLLFFBQUcsQUFBbUIsQUFBQyxBQUNuQyxBQUFDLEFBQUMsQUFBSTt1QkFBSyxBQUFJLFNBQUssQUFBRyxBQUFDLEtBQUMsQUFBQyxBQUN4QixBQUFJO3FCQUFDLEFBQUssUUFBRyxBQUFZLEFBQUMsQUFDNUIsQUFBQyxBQUFDLEFBQUk7QUFGQyxBQUFFLEFBQUMsbUJBRUgsQUFBRSxBQUFDLElBQUMsQUFBVSxXQUFDLEFBQUks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LFVBQUUsQUFBa0IsQUFBQyxBQUFDLEFBQzNELEFBQU07bUJBQUMsQUFBcUIsQUFBQyxBQUMvQixBQUFDO0FBRUQsQUFBSSxBQUFjOzs7NEJBQ2hCO2dCQUFJLEFBQUksT0FBRyxBQUFJLEtBQUMsQUFBVyxBQUFDLEFBQzVCLEFBQU07bUJBQUMsQUFBSSxRQUFJLEFBQUksS0FBQyxBQUFJLFNBQUssQUFBa0Isb0JBQUUsQUFBb0IsQUFBQyxBQUFDLEFBQ3ZFLEFBQU07bUJBQUMsQUFBNEIsQUFBQyxBQUN0QyxBQUFDO0FBRUQsQUFBSSxBQUFXOzs7NEJBQ2I7Z0JBQUksQUFBSSxPQUFHLEFBQUksS0FBQyxBQUFXLEFBQUMsQUFDNUIsQUFBTTttQkFBQyxBQUFJLFFBQUksQUFBSSxLQUFDLEFBQUksU0FBSyxBQUFVLFlBQUUsQUFBc0IsQUFBQyxBQUFDLEFBQ2pFLEFBQU07bUJBQUMsQUFBb0IsQUFBQyxBQUU5QixBQUFDO0FBSUQsQUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV2ZW50ZWRUb2tlbml6ZXIsXG4gIEVudGl0eVBhcnNlcixcbiAgSFRNTDVOYW1lZENoYXJSZWZzIGFzIG5hbWVkQ2hhclJlZnNcbn0gZnJvbSBcInNpbXBsZS1odG1sLXRva2VuaXplclwiO1xuaW1wb3J0IHsgUHJvZ3JhbSB9IGZyb20gXCIuL3R5cGVzL25vZGVzXCI7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSBcIi4vdHlwZXMvbm9kZXNcIjtcbmltcG9ydCAqIGFzIEhhbmRsZWJhcnNBU1QgZnJvbSAnLi90eXBlcy9oYW5kbGViYXJzLWFzdCc7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGFzc2VydCwgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cbmNvbnN0IGVudGl0eVBhcnNlciA9IG5ldyBFbnRpdHlQYXJzZXIobmFtZWRDaGFyUmVmcyk7XG5cbmV4cG9ydCB0eXBlIEVsZW1lbnQgPSBBU1QuUHJvZ3JhbSB8IEFTVC5FbGVtZW50Tm9kZTtcblxuZXhwb3J0IGludGVyZmFjZSBUYWc8VCBleHRlbmRzICdTdGFydFRhZycgfCAnRW5kVGFnJz4ge1xuICB0eXBlOiBUO1xuICBuYW1lOiBzdHJpbmc7XG4gIGF0dHJpYnV0ZXM6IGFueVtdO1xuICBtb2RpZmllcnM6IGFueVtdO1xuICBjb21tZW50czogYW55W107XG4gIHNlbGZDbG9zaW5nOiBib29sZWFuO1xuICBsb2M6IEFTVC5Tb3VyY2VMb2NhdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdHRyaWJ1dGUge1xuICBuYW1lOiBzdHJpbmc7XG4gIHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdO1xuICBpc1F1b3RlZDogYm9vbGVhbjtcbiAgaXNEeW5hbWljOiBib29sZWFuO1xuICBzdGFydDogQVNULlBvc2l0aW9uO1xuICB2YWx1ZVN0YXJ0TGluZTogbnVtYmVyO1xuICB2YWx1ZVN0YXJ0Q29sdW1uOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBQYXJzZXIge1xuICBwcm90ZWN0ZWQgZWxlbWVudFN0YWNrOiBFbGVtZW50W10gPSBbXTtcbiAgcHJpdmF0ZSBvcHRpb25zOiBPYmplY3Q7XG4gIHByaXZhdGUgc291cmNlOiBzdHJpbmdbXTtcbiAgcHVibGljIGN1cnJlbnRBdHRyaWJ1dGU6IE9wdGlvbjxBdHRyaWJ1dGU+ID0gbnVsbDtcbiAgcHVibGljIGN1cnJlbnROb2RlOiBPcHRpb248QVNULkNvbW1lbnRTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUgfCBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPj4gPSBudWxsO1xuICBwdWJsaWMgdG9rZW5pemVyID0gbmV3IEV2ZW50ZWRUb2tlbml6ZXIodGhpcywgZW50aXR5UGFyc2VyKTtcblxuICBjb25zdHJ1Y3Rvcihzb3VyY2U6IHN0cmluZywgb3B0aW9uczogT2JqZWN0ID0ge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdGhpcy50b2tlbml6ZXJbJ3N0YXRlcyddLnRhZ09wZW4gPSBmdW5jdGlvbigpIHtcbiAgICAgIGxldCBjaGFyID0gdGhpcy5jb25zdW1lKCk7XG4gICAgICBpZiAoY2hhciA9PT0gXCIhXCIpIHtcbiAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYXJrdXBEZWNsYXJhdGlvbic7XG4gICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IFwiL1wiKSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSAnZW5kVGFnT3Blbic7XG4gICAgICB9IGVsc2UgaWYgKC9bQS1aYS16XS8udGVzdChjaGFyKSkge1xuICAgICAgICB0aGlzLnN0YXRlID0gJ3RhZ05hbWUnO1xuICAgICAgICB0aGlzLmRlbGVnYXRlLmJlZ2luU3RhcnRUYWcoKTtcbiAgICAgICAgdGhpcy5kZWxlZ2F0ZS5hcHBlbmRUb1RhZ05hbWUoY2hhcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMudG9rZW5pemVyWydzdGF0ZXMnXS5lbmRUYWdPcGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGNoYXIgPSB0aGlzLmNvbnN1bWUoKTtcbiAgICAgIGlmICgvW0EtWmEtel0vLnRlc3QoY2hhcikpIHtcbiAgICAgICAgdGhpcy5zdGF0ZSA9ICd0YWdOYW1lJztcbiAgICAgICAgdGhpcy5kZWxlZ2F0ZS5iZWdpbkVuZFRhZygpO1xuICAgICAgICB0aGlzLmRlbGVnYXRlLmFwcGVuZFRvVGFnTmFtZShjaGFyKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5zb3VyY2UgPSBzb3VyY2Uuc3BsaXQoLyg/Olxcclxcbj98XFxuKS9nKTtcbiAgfVxuXG4gIGdldCBjdXJyZW50QXR0cigpOiBBdHRyaWJ1dGUge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5jdXJyZW50QXR0cmlidXRlLCAnZXhwZWN0ZWQgYXR0cmlidXRlJyk7XG4gIH1cblxuICBnZXQgY3VycmVudFRhZygpOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIChub2RlLnR5cGUgPT09ICdTdGFydFRhZycgfHwgbm9kZS50eXBlID09PSAnRW5kVGFnJyksICdleHBlY3RlZCB0YWcnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPjtcbiAgfVxuXG4gIGdldCBjdXJyZW50U3RhcnRUYWcoKTogVGFnPCdTdGFydFRhZyc+IHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnU3RhcnRUYWcnLCAnZXhwZWN0ZWQgc3RhcnQgdGFnJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgVGFnPCdTdGFydFRhZyc+O1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRFbmRUYWcoKTogVGFnPCdFbmRUYWcnPiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ0VuZFRhZycsICdleHBlY3RlZCBlbmQgdGFnJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgVGFnPCdFbmRUYWcnPjtcbiAgfVxuXG4gIGdldCBjdXJyZW50Q29tbWVudCgpOiBBU1QuQ29tbWVudFN0YXRlbWVudCB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ0NvbW1lbnRTdGF0ZW1lbnQnLCAnZXhwZWN0ZWQgYSBjb21tZW50Jyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgQVNULkNvbW1lbnRTdGF0ZW1lbnQ7XG4gIH1cblxuICBnZXQgY3VycmVudERhdGEoKTogQVNULlRleHROb2RlIHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnVGV4dE5vZGUnLCAnZXhwZWN0ZWQgYSB0ZXh0IG5vZGUnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBBU1QuVGV4dE5vZGU7XG5cbiAgfVxuXG4gIGFjY2VwdE5vZGUobm9kZTogSGFuZGxlYmFyc0FTVC5Qcm9ncmFtKTogUHJvZ3JhbTtcbiAgYWNjZXB0Tm9kZTxVIGV4dGVuZHMgQVNULk5vZGU+KG5vZGU6IEhhbmRsZWJhcnNBU1QuTm9kZSk6IFU7XG4gIGFjY2VwdE5vZGUobm9kZTogSGFuZGxlYmFyc0FTVC5Ob2RlKTogYW55IHtcbiAgICByZXR1cm4gdGhpc1tub2RlLnR5cGVdKG5vZGUpO1xuICB9XG5cbiAgY3VycmVudEVsZW1lbnQoKTogRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudFN0YWNrW3RoaXMuZWxlbWVudFN0YWNrLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgc291cmNlRm9yTm9kZShub2RlOiBIYW5kbGViYXJzQVNULk5vZGUsIGVuZE5vZGU/OiB7IGxvYzogSGFuZGxlYmFyc0FTVC5Tb3VyY2VMb2NhdGlvbiB9KTogc3RyaW5nIHtcbiAgICBsZXQgZmlyc3RMaW5lID0gbm9kZS5sb2Muc3RhcnQubGluZSAtIDE7XG4gICAgbGV0IGN1cnJlbnRMaW5lID0gZmlyc3RMaW5lIC0gMTtcbiAgICBsZXQgZmlyc3RDb2x1bW4gPSBub2RlLmxvYy5zdGFydC5jb2x1bW47XG4gICAgbGV0IHN0cmluZyA9IFtdO1xuICAgIGxldCBsaW5lO1xuXG4gICAgbGV0IGxhc3RMaW5lOiBudW1iZXI7XG4gICAgbGV0IGxhc3RDb2x1bW46IG51bWJlcjtcblxuICAgIGlmIChlbmROb2RlKSB7XG4gICAgICBsYXN0TGluZSA9IGVuZE5vZGUubG9jLmVuZC5saW5lIC0gMTtcbiAgICAgIGxhc3RDb2x1bW4gPSBlbmROb2RlLmxvYy5lbmQuY29sdW1uO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXN0TGluZSA9IG5vZGUubG9jLmVuZC5saW5lIC0gMTtcbiAgICAgIGxhc3RDb2x1bW4gPSBub2RlLmxvYy5lbmQuY29sdW1uO1xuICAgIH1cblxuICAgIHdoaWxlIChjdXJyZW50TGluZSA8IGxhc3RMaW5lKSB7XG4gICAgICBjdXJyZW50TGluZSsrO1xuICAgICAgbGluZSA9IHRoaXMuc291cmNlW2N1cnJlbnRMaW5lXTtcblxuICAgICAgaWYgKGN1cnJlbnRMaW5lID09PSBmaXJzdExpbmUpIHtcbiAgICAgICAgaWYgKGZpcnN0TGluZSA9PT0gbGFzdExpbmUpIHtcbiAgICAgICAgICBzdHJpbmcucHVzaChsaW5lLnNsaWNlKGZpcnN0Q29sdW1uLCBsYXN0Q29sdW1uKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RyaW5nLnB1c2gobGluZS5zbGljZShmaXJzdENvbHVtbikpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRMaW5lID09PSBsYXN0TGluZSkge1xuICAgICAgICBzdHJpbmcucHVzaChsaW5lLnNsaWNlKDAsIGxhc3RDb2x1bW4pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0cmluZy5wdXNoKGxpbmUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdHJpbmcuam9pbignXFxuJyk7XG4gIH1cbn1cbiJdfQ==