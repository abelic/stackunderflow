import b, { SYNTHETIC } from "../builders";
import { appendChild, parseElementBlockParams } from "../utils";
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from "../builders";
import traverse from "../traversal/traverse";
import print from "../generation/print";
import Walker from "../traversal/walker";
import * as handlebars from "handlebars";
import { assign } from '@glimmer/util';
const voidMap = Object.create(null);
let voidTagNames = "area base br col command embed hr img input keygen link meta param source track wbr";
voidTagNames.split(" ").forEach(tagName => {
    voidMap[tagName] = true;
});
export class TokenizerEventHandlers extends HandlebarsNodeVisitors {
    constructor() {
        super(...arguments);
        this.tagOpenLine = 0;
        this.tagOpenColumn = 0;
    }
    reset() {
        this.currentNode = null;
    }
    // Comment
    beginComment() {
        this.currentNode = b.comment("");
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    }
    appendToCommentData(char) {
        this.currentComment.value += char;
    }
    finishComment() {
        this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentComment);
    }
    // Data
    beginData() {
        this.currentNode = b.text();
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    }
    appendToData(char) {
        this.currentData.chars += char;
    }
    finishData() {
        this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentData);
    }
    // Tags - basic
    tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    }
    beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    finishTag() {
        let { line, column } = this.tokenizer;
        let tag = this.currentTag;
        tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    }
    finishStartTag() {
        let { name, attributes, modifiers, comments } = this.currentStartTag;
        let loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
        let element = b.element(name, attributes, modifiers, [], comments, loc);
        this.elementStack.push(element);
    }
    finishEndTag(isVoid) {
        let tag = this.currentTag;
        let element = this.elementStack.pop();
        let parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        parseElementBlockParams(element);
        appendChild(parent, element);
    }
    markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    }
    // Tags - name
    appendToTagName(char) {
        this.currentTag.name += char;
    }
    // Tags - attributes
    beginAttribute() {
        let tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new SyntaxError(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
        }
        this.currentAttribute = {
            name: "",
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    }
    appendToAttributeName(char) {
        this.currentAttr.name += char;
    }
    beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    }
    appendToAttributeValue(char) {
        let parts = this.currentAttr.parts;
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            let loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            let text = b.text(char, loc);
            parts.push(text);
        }
    }
    finishAttributeValue() {
        let { name, parts, isQuoted, isDynamic, valueStartLine, valueStartColumn } = this.currentAttr;
        let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        let loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        let attribute = b.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    }
    reportSyntaxError(message) {
        throw new SyntaxError(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, b.loc(this.tokenizer.line, this.tokenizer.column));
    }
}
;
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new SyntaxError(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, b.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : b.text("");
    }
}
function assembleConcatenatedValue(parts) {
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new SyntaxError("Unsupported node in quoted attribute value: " + part['type'], part.loc);
        }
    }
    return b.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    let error;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = "Invalid end tag " + formatEndTagInfo(tag) + " (void elements cannot have end tags).";
    } else if (element.tag === undefined) {
        error = "Closing tag " + formatEndTagInfo(tag) + " without an open tag.";
    } else if (element.tag !== tag.name) {
        error = "Closing tag " + formatEndTagInfo(tag) + " did not match last open tag `" + element.tag + "` (on line " + element.loc.start.line + ").";
    }
    if (error) {
        throw new SyntaxError(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return "`" + tag.name + "` (on line " + tag.loc.end.line + ")";
}
export const syntax = {
    parse: preprocess,
    builders,
    print,
    traverse,
    Walker
};
export function preprocess(html, options) {
    let ast = typeof html === 'object' ? html : handlebars.parse(html);
    let program = new TokenizerEventHandlers(html, options).acceptNode(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
            let transform = options.plugins.ast[i];
            let env = assign({}, options, { syntax }, { plugins: undefined });
            let pluginResult = transform(env);
            traverse(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sQUFBQyxBQUFFLEtBQUUsQUFBUyxBQUFFLGlCQUFNLEFBQWEsQUFBQztBQUMzQyxBQUFPLFNBQUUsQUFBVyxhQUFFLEFBQXVCLEFBQUUsK0JBQU0sQUFBVSxBQUFDO0FBQ2hFLEFBQU8sU0FBRSxBQUFzQixBQUFFLDhCQUFNLEFBQTRCLEFBQUM7QUFFcEUsT0FBTyxBQUFXLGlCQUFNLEFBQXdCLEFBQUM7QUFFakQsT0FBTyxBQUFRLGNBQU0sQUFBYSxBQUFDO0FBQ25DLE9BQU8sQUFBeUIsY0FBTSxBQUF1QixBQUFDO0FBQzlELE9BQU8sQUFBSyxXQUFNLEFBQXFCLEFBQUM7QUFDeEMsT0FBTyxBQUFNLFlBQU0sQUFBcUIsQUFBQztBQUN6QyxPQUFPLEtBQUssQUFBVSxnQkFBTSxBQUFZLEFBQUM7QUFDekMsQUFBTyxTQUFFLEFBQU0sQUFBRSxjQUFNLEFBQWUsQUFBQztBQUd2QyxNQUFNLEFBQU8sVUFFVCxBQUFNLE9BQUMsQUFBTSxPQUFDLEFBQUksQUFBQyxBQUFDO0FBRXhCLElBQUksQUFBWSxlQUFHLEFBQXFGLEFBQUM7QUFDekcsQUFBWSxhQUFDLEFBQUssTUFBQyxBQUFHLEFBQUMsS0FBQyxBQUFPLFFBQUMsQUFBTztBQUNyQyxBQUFPLFlBQUMsQUFBTyxBQUFDLFdBQUcsQUFBSSxBQUFDLEFBQzFCO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBTSxhQUE4QiwrQkFBUSxBQUFzQjtBQUFsRTs7QUFDVSxhQUFXLGNBQUcsQUFBQyxBQUFDO0FBQ2hCLGFBQWEsZ0JBQUcsQUFBQyxBQUFDLEFBbU41QjtBQUFDO0FBak5DLEFBQUs7QUFDSCxBQUFJLGFBQUMs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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiLCB7IFNZTlRIRVRJQyB9IGZyb20gXCIuLi9idWlsZGVyc1wiO1xuaW1wb3J0IHsgYXBwZW5kQ2hpbGQsIHBhcnNlRWxlbWVudEJsb2NrUGFyYW1zIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG5pbXBvcnQgeyBIYW5kbGViYXJzTm9kZVZpc2l0b3JzIH0gZnJvbSAnLi9oYW5kbGViYXJzLW5vZGUtdmlzaXRvcnMnO1xuaW1wb3J0ICogYXMgQVNUIGZyb20gXCIuLi90eXBlcy9ub2Rlc1wiO1xuaW1wb3J0IFN5bnRheEVycm9yIGZyb20gJy4uL2Vycm9ycy9zeW50YXgtZXJyb3InO1xuaW1wb3J0IHsgVGFnIH0gZnJvbSBcIi4uL3BhcnNlclwiO1xuaW1wb3J0IGJ1aWxkZXJzIGZyb20gXCIuLi9idWlsZGVyc1wiO1xuaW1wb3J0IHRyYXZlcnNlLCB7IE5vZGVWaXNpdG9yIH0gZnJvbSBcIi4uL3RyYXZlcnNhbC90cmF2ZXJzZVwiO1xuaW1wb3J0IHByaW50IGZyb20gXCIuLi9nZW5lcmF0aW9uL3ByaW50XCI7XG5pbXBvcnQgV2Fsa2VyIGZyb20gXCIuLi90cmF2ZXJzYWwvd2Fsa2VyXCI7XG5pbXBvcnQgKiBhcyBoYW5kbGViYXJzIGZyb20gXCJoYW5kbGViYXJzXCI7XG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFJlY2FzdCB9IGZyb20gXCJAZ2xpbW1lci9pbnRlcmZhY2VzXCI7XG5cbmNvbnN0IHZvaWRNYXA6IHtcbiAgW3RhZ05hbWU6IHN0cmluZ106IGJvb2xlYW5cbn0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5sZXQgdm9pZFRhZ05hbWVzID0gXCJhcmVhIGJhc2UgYnIgY29sIGNvbW1hbmQgZW1iZWQgaHIgaW1nIGlucHV0IGtleWdlbiBsaW5rIG1ldGEgcGFyYW0gc291cmNlIHRyYWNrIHdiclwiO1xudm9pZFRhZ05hbWVzLnNwbGl0KFwiIFwiKS5mb3JFYWNoKHRhZ05hbWUgPT4ge1xuICB2b2lkTWFwW3RhZ05hbWVdID0gdHJ1ZTtcbn0pO1xuXG5leHBvcnQgY2xhc3MgVG9rZW5pemVyRXZlbnRIYW5kbGVycyBleHRlbmRzIEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMge1xuICBwcml2YXRlIHRhZ09wZW5MaW5lID0gMDtcbiAgcHJpdmF0ZSB0YWdPcGVuQ29sdW1uID0gMDtcblxuICByZXNldCgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gbnVsbDtcbiAgfVxuXG4gIC8vIENvbW1lbnRcblxuICBiZWdpbkNvbW1lbnQoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IGIuY29tbWVudChcIlwiKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pLFxuICAgICAgZW5kOiBudWxsIGFzIFJlY2FzdDxudWxsLCBBU1QuUG9zaXRpb24+XG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvQ29tbWVudERhdGEoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50Q29tbWVudC52YWx1ZSArPSBjaGFyO1xuICB9XG5cbiAgZmluaXNoQ29tbWVudCgpIHtcbiAgICB0aGlzLmN1cnJlbnRDb21tZW50LmxvYy5lbmQgPSBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pO1xuXG4gICAgYXBwZW5kQ2hpbGQodGhpcy5jdXJyZW50RWxlbWVudCgpLCB0aGlzLmN1cnJlbnRDb21tZW50KTtcbiAgfVxuXG4gIC8vIERhdGFcblxuICBiZWdpbkRhdGEoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IGIudGV4dCgpO1xuICAgIHRoaXMuY3VycmVudE5vZGUubG9jID0ge1xuICAgICAgc291cmNlOiBudWxsLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbiksXG4gICAgICBlbmQ6IG51bGwgYXMgUmVjYXN0PG51bGwsIEFTVC5Qb3NpdGlvbj5cbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9EYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudERhdGEuY2hhcnMgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaERhdGEoKSB7XG4gICAgdGhpcy5jdXJyZW50RGF0YS5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50RGF0YSk7XG4gIH1cblxuICAvLyBUYWdzIC0gYmFzaWNcblxuICB0YWdPcGVuKCkge1xuICAgIHRoaXMudGFnT3BlbkxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMudGFnT3BlbkNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGJlZ2luU3RhcnRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdTdGFydFRhZycsXG4gICAgICBuYW1lOiBcIlwiLFxuICAgICAgYXR0cmlidXRlczogW10sXG4gICAgICBtb2RpZmllcnM6IFtdLFxuICAgICAgY29tbWVudHM6IFtdLFxuICAgICAgc2VsZkNsb3Npbmc6IGZhbHNlLFxuICAgICAgbG9jOiBTWU5USEVUSUNcbiAgICB9O1xuICB9XG5cbiAgYmVnaW5FbmRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdFbmRUYWcnLFxuICAgICAgbmFtZTogXCJcIixcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDXG4gICAgfTtcbiAgfVxuXG4gIGZpbmlzaFRhZygpIHtcbiAgICBsZXQgeyBsaW5lLCBjb2x1bW4gfSA9IHRoaXMudG9rZW5pemVyO1xuXG4gICAgbGV0IHRhZyA9IHRoaXMuY3VycmVudFRhZztcbiAgICB0YWcubG9jID0gYi5sb2ModGhpcy50YWdPcGVuTGluZSwgdGhpcy50YWdPcGVuQ29sdW1uLCBsaW5lLCBjb2x1bW4pO1xuXG4gICAgaWYgKHRhZy50eXBlID09PSAnU3RhcnRUYWcnKSB7XG4gICAgICB0aGlzLmZpbmlzaFN0YXJ0VGFnKCk7XG5cbiAgICAgIGlmICh2b2lkTWFwW3RhZy5uYW1lXSB8fCB0YWcuc2VsZkNsb3NpbmcpIHtcbiAgICAgICAgdGhpcy5maW5pc2hFbmRUYWcodHJ1ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0YWcudHlwZSA9PT0gJ0VuZFRhZycpIHtcbiAgICAgIHRoaXMuZmluaXNoRW5kVGFnKGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICBmaW5pc2hTdGFydFRhZygpIHtcbiAgICBsZXQgeyBuYW1lLCBhdHRyaWJ1dGVzLCBtb2RpZmllcnMsIGNvbW1lbnRzIH0gPSB0aGlzLmN1cnJlbnRTdGFydFRhZztcblxuICAgIGxldCBsb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pO1xuICAgIGxldCBlbGVtZW50ID0gYi5lbGVtZW50KG5hbWUsIGF0dHJpYnV0ZXMsIG1vZGlmaWVycywgW10sIGNvbW1lbnRzLCBsb2MpO1xuICAgIHRoaXMuZWxlbWVudFN0YWNrLnB1c2goZWxlbWVudCk7XG4gIH1cblxuICBmaW5pc2hFbmRUYWcoaXNWb2lkOiBib29sZWFuKSB7XG4gICAgbGV0IHRhZyA9IHRoaXMuY3VycmVudFRhZztcblxuICAgIGxldCBlbGVtZW50ID0gdGhpcy5lbGVtZW50U3RhY2sucG9wKCkgYXMgQVNULkVsZW1lbnROb2RlO1xuICAgIGxldCBwYXJlbnQgPSB0aGlzLmN1cnJlbnRFbGVtZW50KCk7XG5cbiAgICB2YWxpZGF0ZUVuZFRhZyh0YWcsIGVsZW1lbnQsIGlzVm9pZCk7XG5cbiAgICBlbGVtZW50LmxvYy5lbmQubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgZWxlbWVudC5sb2MuZW5kLmNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcblxuICAgIHBhcnNlRWxlbWVudEJsb2NrUGFyYW1zKGVsZW1lbnQpO1xuICAgIGFwcGVuZENoaWxkKHBhcmVudCwgZWxlbWVudCk7XG4gIH1cblxuICBtYXJrVGFnQXNTZWxmQ2xvc2luZygpIHtcbiAgICB0aGlzLmN1cnJlbnRUYWcuc2VsZkNsb3NpbmcgPSB0cnVlO1xuICB9XG5cbiAgLy8gVGFncyAtIG5hbWVcblxuICBhcHBlbmRUb1RhZ05hbWUoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50VGFnLm5hbWUgKz0gY2hhcjtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBhdHRyaWJ1dGVzXG5cbiAgYmVnaW5BdHRyaWJ1dGUoKSB7XG4gICAgbGV0IHRhZyA9IHRoaXMuY3VycmVudFRhZztcbiAgICBpZiAodGFnLnR5cGUgPT09ICdFbmRUYWcnKSB7XG4gICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICBgSW52YWxpZCBlbmQgdGFnOiBjbG9zaW5nIHRhZyBtdXN0IG5vdCBoYXZlIGF0dHJpYnV0ZXMsIGAgK1xuICAgICAgICBgaW4gXFxgJHt0YWcubmFtZX1cXGAgKG9uIGxpbmUgJHt0aGlzLnRva2VuaXplci5saW5lfSkuYCxcbiAgICAgICAgdGFnLmxvY1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRBdHRyaWJ1dGUgPSB7XG4gICAgICBuYW1lOiBcIlwiLFxuICAgICAgcGFydHM6IFtdLFxuICAgICAgaXNRdW90ZWQ6IGZhbHNlLFxuICAgICAgaXNEeW5hbWljOiBmYWxzZSxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgdmFsdWVTdGFydExpbmU6IDAsXG4gICAgICB2YWx1ZVN0YXJ0Q29sdW1uOiAwXG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvQXR0cmlidXRlTmFtZShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLm5hbWUgKz0gY2hhcjtcbiAgfVxuXG4gIGJlZ2luQXR0cmlidXRlVmFsdWUoaXNRdW90ZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLmlzUXVvdGVkID0gaXNRdW90ZWQ7XG4gICAgdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0TGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0Q29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuICB9XG5cbiAgYXBwZW5kVG9BdHRyaWJ1dGVWYWx1ZShjaGFyOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFydHMgPSB0aGlzLmN1cnJlbnRBdHRyLnBhcnRzO1xuICAgIGxldCBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdO1xuXG4gICAgaWYgKGxhc3RQYXJ0ICYmIGxhc3RQYXJ0LnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgIGxhc3RQYXJ0LmNoYXJzICs9IGNoYXI7XG5cbiAgICAgIC8vIHVwZGF0ZSBlbmQgbG9jYXRpb24gZm9yIGVhY2ggYWRkZWQgY2hhclxuICAgICAgbGFzdFBhcnQubG9jLmVuZC5saW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICAgIGxhc3RQYXJ0LmxvYy5lbmQuY29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpbml0aWFsbHkgYXNzdW1lIHRoZSB0ZXh0IG5vZGUgaXMgYSBzaW5nbGUgY2hhclxuICAgICAgbGV0IGxvYyA9IGIubG9jKFxuICAgICAgICB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4sXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtblxuICAgICAgKTtcblxuICAgICAgLy8gY29ycmVjdCBmb3IgYFxcbmAgYXMgZmlyc3QgY2hhclxuICAgICAgaWYgKGNoYXIgPT09ICdcXG4nKSB7XG4gICAgICAgIGxvYy5zdGFydC5saW5lIC09IDE7XG4gICAgICAgIGxvYy5zdGFydC5jb2x1bW4gPSBsYXN0UGFydCA/IGxhc3RQYXJ0LmxvYy5lbmQuY29sdW1uIDogdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0Q29sdW1uO1xuICAgICAgfVxuXG4gICAgICBsZXQgdGV4dCA9IGIudGV4dChjaGFyLCBsb2MpO1xuICAgICAgcGFydHMucHVzaCh0ZXh0KTtcbiAgICB9XG4gIH1cblxuICBmaW5pc2hBdHRyaWJ1dGVWYWx1ZSgpIHtcbiAgICBsZXQgeyBuYW1lLCBwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4gfSA9IHRoaXMuY3VycmVudEF0dHI7XG4gICAgbGV0IHZhbHVlID0gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdGhpcy50b2tlbml6ZXIubGluZSk7XG4gICAgdmFsdWUubG9jID0gYi5sb2MoXG4gICAgICB2YWx1ZVN0YXJ0TGluZSwgdmFsdWVTdGFydENvbHVtbixcbiAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtblxuICAgICk7XG5cbiAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmxpbmUsIHRoaXMuY3VycmVudEF0dHIuc3RhcnQuY29sdW1uLFxuICAgICAgdGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgKTtcblxuICAgIGxldCBhdHRyaWJ1dGUgPSBiLmF0dHIobmFtZSwgdmFsdWUsIGxvYyk7XG5cbiAgICB0aGlzLmN1cnJlbnRTdGFydFRhZy5hdHRyaWJ1dGVzLnB1c2goYXR0cmlidXRlKTtcbiAgfVxuXG4gIHJlcG9ydFN5bnRheEVycm9yKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgU3ludGF4IGVycm9yIGF0IGxpbmUgJHt0aGlzLnRva2VuaXplci5saW5lfSBjb2wgJHt0aGlzLnRva2VuaXplci5jb2x1bW59OiAke21lc3NhZ2V9YCwgYi5sb2ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSk7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQXR0cmlidXRlVmFsdWUocGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10sIGlzUXVvdGVkOiBib29sZWFuLCBpc0R5bmFtaWM6IGJvb2xlYW4sIGxpbmU6IG51bWJlcikge1xuICBpZiAoaXNEeW5hbWljKSB7XG4gICAgaWYgKGlzUXVvdGVkKSB7XG4gICAgICByZXR1cm4gYXNzZW1ibGVDb25jYXRlbmF0ZWRWYWx1ZShwYXJ0cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDEgfHwgKHBhcnRzLmxlbmd0aCA9PT0gMiAmJiBwYXJ0c1sxXS50eXBlID09PSAnVGV4dE5vZGUnICYmIChwYXJ0c1sxXSBhcyBBU1QuVGV4dE5vZGUpLmNoYXJzID09PSAnLycpKSB7XG4gICAgICAgIHJldHVybiBwYXJ0c1swXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgQW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlIG11c3QgYmUgYSBzdHJpbmcgb3IgYSBtdXN0YWNoZSwgYCArXG4gICAgICAgICAgYHByZWNlZWRlZCBieSB3aGl0ZXNwYWNlIG9yIGEgJz0nIGNoYXJhY3RlciwgYW5kIGAgK1xuICAgICAgICAgIGBmb2xsb3dlZCBieSB3aGl0ZXNwYWNlLCBhICc+JyBjaGFyYWN0ZXIsIG9yICcvPicgKG9uIGxpbmUgJHtsaW5lfSlgLFxuICAgICAgICAgIGIubG9jKGxpbmUsIDApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPiAwID8gcGFydHNbMF0gOiBiLnRleHQoXCJcIik7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZW1ibGVDb25jYXRlbmF0ZWRWYWx1ZShwYXJ0czogKEFTVC5NdXN0YWNoZVN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSlbXSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IHBhcnQ6IEFTVC5CYXNlTm9kZSA9IHBhcnRzW2ldO1xuXG4gICAgaWYgKHBhcnQudHlwZSAhPT0gJ011c3RhY2hlU3RhdGVtZW50JyAmJiBwYXJ0LnR5cGUgIT09ICdUZXh0Tm9kZScpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcIlVuc3VwcG9ydGVkIG5vZGUgaW4gcXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZTogXCIgKyBwYXJ0Wyd0eXBlJ10sIHBhcnQubG9jKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYi5jb25jYXQocGFydHMpO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUVuZFRhZyh0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+LCBlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUsIHNlbGZDbG9zaW5nOiBib29sZWFuKSB7XG4gIGxldCBlcnJvcjtcblxuICBpZiAodm9pZE1hcFt0YWcubmFtZV0gJiYgIXNlbGZDbG9zaW5nKSB7XG4gICAgLy8gRW5nVGFnIGlzIGFsc28gY2FsbGVkIGJ5IFN0YXJ0VGFnIGZvciB2b2lkIGFuZCBzZWxmLWNsb3NpbmcgdGFncyAoaS5lLlxuICAgIC8vIDxpbnB1dD4gb3IgPGJyIC8+LCBzbyB3ZSBuZWVkIHRvIGNoZWNrIGZvciB0aGF0IGhlcmUuIE90aGVyd2lzZSwgd2Ugd291bGRcbiAgICAvLyB0aHJvdyBhbiBlcnJvciBmb3IgdGhvc2UgY2FzZXMuXG4gICAgZXJyb3IgPSBcIkludmFsaWQgZW5kIHRhZyBcIiArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArIFwiICh2b2lkIGVsZW1lbnRzIGNhbm5vdCBoYXZlIGVuZCB0YWdzKS5cIjtcbiAgfSBlbHNlIGlmIChlbGVtZW50LnRhZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgZXJyb3IgPSBcIkNsb3NpbmcgdGFnIFwiICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgXCIgd2l0aG91dCBhbiBvcGVuIHRhZy5cIjtcbiAgfSBlbHNlIGlmIChlbGVtZW50LnRhZyAhPT0gdGFnLm5hbWUpIHtcbiAgICBlcnJvciA9IFwiQ2xvc2luZyB0YWcgXCIgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyBcIiBkaWQgbm90IG1hdGNoIGxhc3Qgb3BlbiB0YWcgYFwiICsgZWxlbWVudC50YWcgKyBcImAgKG9uIGxpbmUgXCIgK1xuICAgICAgICAgICAgZWxlbWVudC5sb2Muc3RhcnQubGluZSArIFwiKS5cIjtcbiAgfVxuXG4gIGlmIChlcnJvcikgeyB0aHJvdyBuZXcgU3ludGF4RXJyb3IoZXJyb3IsIGVsZW1lbnQubG9jKTsgfVxufVxuXG5mdW5jdGlvbiBmb3JtYXRFbmRUYWdJbmZvKHRhZzogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4pIHtcbiAgcmV0dXJuIFwiYFwiICsgdGFnLm5hbWUgKyBcImAgKG9uIGxpbmUgXCIgKyB0YWcubG9jLmVuZC5saW5lICsgXCIpXCI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3ludGF4IHtcbiAgcGFyc2U6IHR5cGVvZiBwcmVwcm9jZXNzO1xuICBidWlsZGVyczogdHlwZW9mIGJ1aWxkZXJzO1xuICBwcmludDogdHlwZW9mIHByaW50O1xuICB0cmF2ZXJzZTogdHlwZW9mIHRyYXZlcnNlO1xuICBXYWxrZXI6IHR5cGVvZiBXYWxrZXI7XG59XG5cbmV4cG9ydCBjb25zdCBzeW50YXg6IFN5bnRheCA9IHtcbiAgcGFyc2U6IHByZXByb2Nlc3MsXG4gIGJ1aWxkZXJzLFxuICBwcmludCxcbiAgdHJhdmVyc2UsXG4gIFdhbGtlclxufTtcblxuLyoqXG4gIEFTVFBsdWdpbnMgY2FuIG1ha2UgY2hhbmdlcyB0byB0aGUgR2xpbW1lciB0ZW1wbGF0ZSBBU1QgYmVmb3JlXG4gIGNvbXBpbGF0aW9uIGJlZ2lucy5cbiovXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbkJ1aWxkZXIge1xuICAoZW52OiBBU1RQbHVnaW5FbnZpcm9ubWVudCk6IEFTVFBsdWdpbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW4ge1xuICBuYW1lOiBzdHJpbmc7XG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbkVudmlyb25tZW50IHtcbiAgbWV0YT86IGFueTtcbiAgc3ludGF4OiBTeW50YXg7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJlcHJvY2Vzc09wdGlvbnMge1xuICBwbHVnaW5zPzoge1xuICAgIGFzdD86IEFTVFBsdWdpbkJ1aWxkZXJbXTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZXByb2Nlc3MoaHRtbDogc3RyaW5nLCBvcHRpb25zPzogUHJlcHJvY2Vzc09wdGlvbnMpOiBBU1QuUHJvZ3JhbSB7XG4gIGxldCBhc3QgPSAodHlwZW9mIGh0bWwgPT09ICdvYmplY3QnKSA/IGh0bWwgOiBoYW5kbGViYXJzLnBhcnNlKGh0bWwpO1xuICBsZXQgcHJvZ3JhbSA9IG5ldyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzKGh0bWwsIG9wdGlvbnMpLmFjY2VwdE5vZGUoYXN0KTtcblxuICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBsdWdpbnMgJiYgb3B0aW9ucy5wbHVnaW5zLmFzdCkge1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3B0aW9ucy5wbHVnaW5zLmFzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGxldCB0cmFuc2Zvcm0gPSBvcHRpb25zLnBsdWdpbnMuYXN0W2ldO1xuICAgICAgbGV0IGVudiA9IGFzc2lnbih7fSwgb3B0aW9ucywgeyBzeW50YXggfSwgeyBwbHVnaW5zOiB1bmRlZmluZWQgfSk7XG5cbiAgICAgIGxldCBwbHVnaW5SZXN1bHQgPSB0cmFuc2Zvcm0oZW52KTtcblxuICAgICAgdHJhdmVyc2UocHJvZ3JhbSwgcGx1Z2luUmVzdWx0LnZpc2l0b3IpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm9ncmFtO1xufVxuIl19