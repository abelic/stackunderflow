"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.syntax = exports.TokenizerEventHandlers = undefined;
exports.preprocess = preprocess;

var _builders = require("../builders");

var _builders2 = _interopRequireDefault(_builders);

var _utils = require("../utils");

var _handlebarsNodeVisitors = require("./handlebars-node-visitors");

var _syntaxError = require("../errors/syntax-error");

var _syntaxError2 = _interopRequireDefault(_syntaxError);

var _traverse = require("../traversal/traverse");

var _traverse2 = _interopRequireDefault(_traverse);

var _print = require("../generation/print");

var _print2 = _interopRequireDefault(_print);

var _walker = require("../traversal/walker");

var _walker2 = _interopRequireDefault(_walker);

var _handlebars = require("handlebars");

var handlebars = _interopRequireWildcard(_handlebars);

var _util = require("@glimmer/util");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const voidMap = Object.create(null);
let voidTagNames = "area base br col command embed hr img input keygen link meta param source track wbr";
voidTagNames.split(" ").forEach(tagName => {
    voidMap[tagName] = true;
});
class TokenizerEventHandlers extends _handlebarsNodeVisitors.HandlebarsNodeVisitors {
    constructor() {
        super(...arguments);
        this.tagOpenLine = 0;
        this.tagOpenColumn = 0;
    }
    reset() {
        this.currentNode = null;
    }
    // Comment
    beginComment() {
        this.currentNode = _builders2.default.comment("");
        this.currentNode.loc = {
            source: null,
            start: _builders2.default.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    }
    appendToCommentData(char) {
        this.currentComment.value += char;
    }
    finishComment() {
        this.currentComment.loc.end = _builders2.default.pos(this.tokenizer.line, this.tokenizer.column);
        (0, _utils.appendChild)(this.currentElement(), this.currentComment);
    }
    // Data
    beginData() {
        this.currentNode = _builders2.default.text();
        this.currentNode.loc = {
            source: null,
            start: _builders2.default.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    }
    appendToData(char) {
        this.currentData.chars += char;
    }
    finishData() {
        this.currentData.loc.end = _builders2.default.pos(this.tokenizer.line, this.tokenizer.column);
        (0, _utils.appendChild)(this.currentElement(), this.currentData);
    }
    // Tags - basic
    tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    }
    beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: _builders.SYNTHETIC
        };
    }
    beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: _builders.SYNTHETIC
        };
    }
    finishTag() {
        let { line, column } = this.tokenizer;
        let tag = this.currentTag;
        tag.loc = _builders2.default.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    }
    finishStartTag() {
        let { name, attributes, modifiers, comments } = this.currentStartTag;
        let loc = _builders2.default.loc(this.tagOpenLine, this.tagOpenColumn);
        let element = _builders2.default.element(name, attributes, modifiers, [], comments, loc);
        this.elementStack.push(element);
    }
    finishEndTag(isVoid) {
        let tag = this.currentTag;
        let element = this.elementStack.pop();
        let parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        (0, _utils.parseElementBlockParams)(element);
        (0, _utils.appendChild)(parent, element);
    }
    markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    }
    // Tags - name
    appendToTagName(char) {
        this.currentTag.name += char;
    }
    // Tags - attributes
    beginAttribute() {
        let tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new _syntaxError2.default(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
        }
        this.currentAttribute = {
            name: "",
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: _builders2.default.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    }
    appendToAttributeName(char) {
        this.currentAttr.name += char;
    }
    beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    }
    appendToAttributeValue(char) {
        let parts = this.currentAttr.parts;
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            let loc = _builders2.default.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            let text = _builders2.default.text(char, loc);
            parts.push(text);
        }
    }
    finishAttributeValue() {
        let { name, parts, isQuoted, isDynamic, valueStartLine, valueStartColumn } = this.currentAttr;
        let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = _builders2.default.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        let loc = _builders2.default.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        let attribute = _builders2.default.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    }
    reportSyntaxError(message) {
        throw new _syntaxError2.default(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, _builders2.default.loc(this.tokenizer.line, this.tokenizer.column));
    }
}
exports.TokenizerEventHandlers = TokenizerEventHandlers;
;
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new _syntaxError2.default(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, _builders2.default.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : _builders2.default.text("");
    }
}
function assembleConcatenatedValue(parts) {
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new _syntaxError2.default("Unsupported node in quoted attribute value: " + part['type'], part.loc);
        }
    }
    return _builders2.default.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    let error;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = "Invalid end tag " + formatEndTagInfo(tag) + " (void elements cannot have end tags).";
    } else if (element.tag === undefined) {
        error = "Closing tag " + formatEndTagInfo(tag) + " without an open tag.";
    } else if (element.tag !== tag.name) {
        error = "Closing tag " + formatEndTagInfo(tag) + " did not match last open tag `" + element.tag + "` (on line " + element.loc.start.line + ").";
    }
    if (error) {
        throw new _syntaxError2.default(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return "`" + tag.name + "` (on line " + tag.loc.end.line + ")";
}
const syntax = exports.syntax = {
    parse: preprocess,
    builders: _builders2.default,
    print: _print2.default,
    traverse: _traverse2.default,
    Walker: _walker2.default
};
function preprocess(html, options) {
    let ast = typeof html === 'object' ? html : handlebars.parse(html);
    let program = new TokenizerEventHandlers(html, options).acceptNode(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
            let transform = options.plugins.ast[i];
            let env = (0, _util.assign)({}, options, { syntax }, { plugins: undefined });
            let pluginResult = transform(env);
            (0, _traverse2.default)(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsQUFBTyxBQUFDLEFBQUUsQUFBRSxBQUFTLEFBQUUsQUFBTSxBQUFhLEFBQUM7Ozs7QUFDM0MsQUFBTyxBQUFFLEFBQVcsQUFBRSxBQUF1QixBQUFFLEFBQU0sQUFBVSxBQUFDOztBQUNoRSxBQUFPLEFBQUUsQUFBc0IsQUFBRSxBQUFNLEFBQTRCLEFBQUM7O0FBRXBFLEFBQU8sQUFBVyxBQUFNLEFBQXdCLEFBQUMsQUFFakQsQUFBTyxBQUFRLEFBQU0sQUFBYSxBQUFDOzs7O0FBQ25DLEFBQU8sQUFBeUIsQUFBTSxBQUF1QixBQUFDOzs7O0FBQzlELEFBQU8sQUFBSyxBQUFNLEFBQXFCLEFBQUM7Ozs7QUFDeEMsQUFBTyxBQUFNLEFBQU0sQUFBcUIsQUFBQzs7OztBQUN6QyxBQUFPOztJQUFLLEFBQVUsQUFBTSxBQUFZLEFBQUM7O0FBQ3pDLEFBQU8sQUFBRSxBQUFNLEFBQUUsQUFBTSxBQUFlLEFBQUM7Ozs7OztBQUd2QyxNQUFNLEFBQU8sVUFFVCxBQUFNLE9BQUMsQUFBTSxPQUFDLEFBQUksQUFBQyxBQUFDO0FBRXhCLElBQUksQUFBWSxlQUFHLEFBQXFGLEFBQUM7QUFDekcsQUFBWSxhQUFDLEFBQUssTUFBQyxBQUFHLEFBQUMsS0FBQyxBQUFPLFFBQUMsQUFBTyxXQUNyQyxBQUFPO1lBQUMsQUFBTyxBQUFDLFdBQUcsQUFBSSxBQUFDLEFBQzFCLEFBQUMsQUFBQyxBQUFDO0FBRUgsQUFBTTtNQUE4QixBQUFRLEFBQXNCOztpQkFDeEQ7YUFBVyxjQUFHLEFBQUMsQUFBQyxBQUNoQjthQUFhLGdCQUFHLEFBQUMsQUFBQyxBQW1ONUIsQUFBQztBQWpO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LEFBQzFDLEFBQUMsQUFDSDtBQUFDO0FBRUQsQUFBTTtXQUFDLEFBQU8sQUFBQyxBQUNqQixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGIsIHsgU1lOVEhFVElDIH0gZnJvbSBcIi4uL2J1aWxkZXJzXCI7XG5pbXBvcnQgeyBhcHBlbmRDaGlsZCwgcGFyc2VFbGVtZW50QmxvY2tQYXJhbXMgfSBmcm9tIFwiLi4vdXRpbHNcIjtcbmltcG9ydCB7IEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMgfSBmcm9tICcuL2hhbmRsZWJhcnMtbm9kZS12aXNpdG9ycyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSBcIi4uL3R5cGVzL25vZGVzXCI7XG5pbXBvcnQgU3ludGF4RXJyb3IgZnJvbSAnLi4vZXJyb3JzL3N5bnRheC1lcnJvcic7XG5pbXBvcnQgeyBUYWcgfSBmcm9tIFwiLi4vcGFyc2VyXCI7XG5pbXBvcnQgYnVpbGRlcnMgZnJvbSBcIi4uL2J1aWxkZXJzXCI7XG5pbXBvcnQgdHJhdmVyc2UsIHsgTm9kZVZpc2l0b3IgfSBmcm9tIFwiLi4vdHJhdmVyc2FsL3RyYXZlcnNlXCI7XG5pbXBvcnQgcHJpbnQgZnJvbSBcIi4uL2dlbmVyYXRpb24vcHJpbnRcIjtcbmltcG9ydCBXYWxrZXIgZnJvbSBcIi4uL3RyYXZlcnNhbC93YWxrZXJcIjtcbmltcG9ydCAqIGFzIGhhbmRsZWJhcnMgZnJvbSBcImhhbmRsZWJhcnNcIjtcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgUmVjYXN0IH0gZnJvbSBcIkBnbGltbWVyL2ludGVyZmFjZXNcIjtcblxuY29uc3Qgdm9pZE1hcDoge1xuICBbdGFnTmFtZTogc3RyaW5nXTogYm9vbGVhblxufSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbmxldCB2b2lkVGFnTmFtZXMgPSBcImFyZWEgYmFzZSBiciBjb2wgY29tbWFuZCBlbWJlZCBociBpbWcgaW5wdXQga2V5Z2VuIGxpbmsgbWV0YSBwYXJhbSBzb3VyY2UgdHJhY2sgd2JyXCI7XG52b2lkVGFnTmFtZXMuc3BsaXQoXCIgXCIpLmZvckVhY2godGFnTmFtZSA9PiB7XG4gIHZvaWRNYXBbdGFnTmFtZV0gPSB0cnVlO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzIGV4dGVuZHMgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB7XG4gIHByaXZhdGUgdGFnT3BlbkxpbmUgPSAwO1xuICBwcml2YXRlIHRhZ09wZW5Db2x1bW4gPSAwO1xuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBudWxsO1xuICB9XG5cbiAgLy8gQ29tbWVudFxuXG4gIGJlZ2luQ29tbWVudCgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi5jb21tZW50KFwiXCIpO1xuICAgIHRoaXMuY3VycmVudE5vZGUubG9jID0ge1xuICAgICAgc291cmNlOiBudWxsLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiksXG4gICAgICBlbmQ6IG51bGwgYXMgUmVjYXN0PG51bGwsIEFTVC5Qb3NpdGlvbj5cbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9Db21tZW50RGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRDb21tZW50LnZhbHVlICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hDb21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudENvbW1lbnQpO1xuICB9XG5cbiAgLy8gRGF0YVxuXG4gIGJlZ2luRGF0YSgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi50ZXh0KCk7XG4gICAgdGhpcy5jdXJyZW50Tm9kZS5sb2MgPSB7XG4gICAgICBzb3VyY2U6IG51bGwsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIGVuZDogbnVsbCBhcyBSZWNhc3Q8bnVsbCwgQVNULlBvc2l0aW9uPlxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0RhdGEoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50RGF0YS5jaGFycyArPSBjaGFyO1xuICB9XG5cbiAgZmluaXNoRGF0YSgpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRhLmxvYy5lbmQgPSBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pO1xuXG4gICAgYXBwZW5kQ2hpbGQodGhpcy5jdXJyZW50RWxlbWVudCgpLCB0aGlzLmN1cnJlbnREYXRhKTtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBiYXNpY1xuXG4gIHRhZ09wZW4oKSB7XG4gICAgdGhpcy50YWdPcGVuTGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgdGhpcy50YWdPcGVuQ29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuICB9XG5cbiAgYmVnaW5TdGFydFRhZygpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0ge1xuICAgICAgdHlwZTogJ1N0YXJ0VGFnJyxcbiAgICAgIG5hbWU6IFwiXCIsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQ1xuICAgIH07XG4gIH1cblxuICBiZWdpbkVuZFRhZygpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0ge1xuICAgICAgdHlwZTogJ0VuZFRhZycsXG4gICAgICBuYW1lOiBcIlwiLFxuICAgICAgYXR0cmlidXRlczogW10sXG4gICAgICBtb2RpZmllcnM6IFtdLFxuICAgICAgY29tbWVudHM6IFtdLFxuICAgICAgc2VsZkNsb3Npbmc6IGZhbHNlLFxuICAgICAgbG9jOiBTWU5USEVUSUNcbiAgICB9O1xuICB9XG5cbiAgZmluaXNoVGFnKCkge1xuICAgIGxldCB7IGxpbmUsIGNvbHVtbiB9ID0gdGhpcy50b2tlbml6ZXI7XG5cbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIHRhZy5sb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4sIGxpbmUsIGNvbHVtbik7XG5cbiAgICBpZiAodGFnLnR5cGUgPT09ICdTdGFydFRhZycpIHtcbiAgICAgIHRoaXMuZmluaXNoU3RhcnRUYWcoKTtcblxuICAgICAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdIHx8IHRhZy5zZWxmQ2xvc2luZykge1xuICAgICAgICB0aGlzLmZpbmlzaEVuZFRhZyh0cnVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhpcy5maW5pc2hFbmRUYWcoZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaFN0YXJ0VGFnKCkge1xuICAgIGxldCB7IG5hbWUsIGF0dHJpYnV0ZXMsIG1vZGlmaWVycywgY29tbWVudHMgfSA9IHRoaXMuY3VycmVudFN0YXJ0VGFnO1xuXG4gICAgbGV0IGxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbik7XG4gICAgbGV0IGVsZW1lbnQgPSBiLmVsZW1lbnQobmFtZSwgYXR0cmlidXRlcywgbW9kaWZpZXJzLCBbXSwgY29tbWVudHMsIGxvYyk7XG4gICAgdGhpcy5lbGVtZW50U3RhY2sucHVzaChlbGVtZW50KTtcbiAgfVxuXG4gIGZpbmlzaEVuZFRhZyhpc1ZvaWQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuXG4gICAgbGV0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnRTdGFjay5wb3AoKSBhcyBBU1QuRWxlbWVudE5vZGU7XG4gICAgbGV0IHBhcmVudCA9IHRoaXMuY3VycmVudEVsZW1lbnQoKTtcblxuICAgIHZhbGlkYXRlRW5kVGFnKHRhZywgZWxlbWVudCwgaXNWb2lkKTtcblxuICAgIGVsZW1lbnQubG9jLmVuZC5saW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICBlbGVtZW50LmxvYy5lbmQuY29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuXG4gICAgcGFyc2VFbGVtZW50QmxvY2tQYXJhbXMoZWxlbWVudCk7XG4gICAgYXBwZW5kQ2hpbGQocGFyZW50LCBlbGVtZW50KTtcbiAgfVxuXG4gIG1hcmtUYWdBc1NlbGZDbG9zaW5nKCkge1xuICAgIHRoaXMuY3VycmVudFRhZy5zZWxmQ2xvc2luZyA9IHRydWU7XG4gIH1cblxuICAvLyBUYWdzIC0gbmFtZVxuXG4gIGFwcGVuZFRvVGFnTmFtZShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRUYWcubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgLy8gVGFncyAtIGF0dHJpYnV0ZXNcblxuICBiZWdpbkF0dHJpYnV0ZSgpIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIGlmICh0YWcudHlwZSA9PT0gJ0VuZFRhZycpIHtcbiAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIGVuZCB0YWc6IGNsb3NpbmcgdGFnIG11c3Qgbm90IGhhdmUgYXR0cmlidXRlcywgYCArXG4gICAgICAgIGBpbiBcXGAke3RhZy5uYW1lfVxcYCAob24gbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9KS5gLFxuICAgICAgICB0YWcubG9jXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudEF0dHJpYnV0ZSA9IHtcbiAgICAgIG5hbWU6IFwiXCIsXG4gICAgICBwYXJ0czogW10sXG4gICAgICBpc1F1b3RlZDogZmFsc2UsXG4gICAgICBpc0R5bmFtaWM6IGZhbHNlLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbiksXG4gICAgICB2YWx1ZVN0YXJ0TGluZTogMCxcbiAgICAgIHZhbHVlU3RhcnRDb2x1bW46IDBcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9BdHRyaWJ1dGVOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudEF0dHIubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgYmVnaW5BdHRyaWJ1dGVWYWx1ZShpc1F1b3RlZDogYm9vbGVhbikge1xuICAgIHRoaXMuY3VycmVudEF0dHIuaXNRdW90ZWQgPSBpc1F1b3RlZDtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRMaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRDb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZVZhbHVlKGNoYXI6IHN0cmluZykge1xuICAgIGxldCBwYXJ0cyA9IHRoaXMuY3VycmVudEF0dHIucGFydHM7XG4gICAgbGV0IGxhc3RQYXJ0ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07XG5cbiAgICBpZiAobGFzdFBhcnQgJiYgbGFzdFBhcnQudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgbGFzdFBhcnQuY2hhcnMgKz0gY2hhcjtcblxuICAgICAgLy8gdXBkYXRlIGVuZCBsb2NhdGlvbiBmb3IgZWFjaCBhZGRlZCBjaGFyXG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgICAgbGFzdFBhcnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGluaXRpYWxseSBhc3N1bWUgdGhlIHRleHQgbm9kZSBpcyBhIHNpbmdsZSBjaGFyXG4gICAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbixcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgICApO1xuXG4gICAgICAvLyBjb3JyZWN0IGZvciBgXFxuYCBhcyBmaXJzdCBjaGFyXG4gICAgICBpZiAoY2hhciA9PT0gJ1xcbicpIHtcbiAgICAgICAgbG9jLnN0YXJ0LmxpbmUgLT0gMTtcbiAgICAgICAgbG9jLnN0YXJ0LmNvbHVtbiA9IGxhc3RQYXJ0ID8gbGFzdFBhcnQubG9jLmVuZC5jb2x1bW4gOiB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRDb2x1bW47XG4gICAgICB9XG5cbiAgICAgIGxldCB0ZXh0ID0gYi50ZXh0KGNoYXIsIGxvYyk7XG4gICAgICBwYXJ0cy5wdXNoKHRleHQpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaEF0dHJpYnV0ZVZhbHVlKCkge1xuICAgIGxldCB7IG5hbWUsIHBhcnRzLCBpc1F1b3RlZCwgaXNEeW5hbWljLCB2YWx1ZVN0YXJ0TGluZSwgdmFsdWVTdGFydENvbHVtbiB9ID0gdGhpcy5jdXJyZW50QXR0cjtcbiAgICBsZXQgdmFsdWUgPSBhc3NlbWJsZUF0dHJpYnV0ZVZhbHVlKHBhcnRzLCBpc1F1b3RlZCwgaXNEeW5hbWljLCB0aGlzLnRva2VuaXplci5saW5lKTtcbiAgICB2YWx1ZS5sb2MgPSBiLmxvYyhcbiAgICAgIHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uLFxuICAgICAgdGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgKTtcblxuICAgIGxldCBsb2MgPSBiLmxvYyhcbiAgICAgIHRoaXMuY3VycmVudEF0dHIuc3RhcnQubGluZSwgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5jb2x1bW4sXG4gICAgICB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICApO1xuXG4gICAgbGV0IGF0dHJpYnV0ZSA9IGIuYXR0cihuYW1lLCB2YWx1ZSwgbG9jKTtcblxuICAgIHRoaXMuY3VycmVudFN0YXJ0VGFnLmF0dHJpYnV0ZXMucHVzaChhdHRyaWJ1dGUpO1xuICB9XG5cbiAgcmVwb3J0U3ludGF4RXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBTeW50YXggZXJyb3IgYXQgbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9IGNvbCAke3RoaXMudG9rZW5pemVyLmNvbHVtbn06ICR7bWVzc2FnZX1gLCBiLmxvYyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShwYXJ0czogKEFTVC5NdXN0YWNoZVN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSlbXSwgaXNRdW90ZWQ6IGJvb2xlYW4sIGlzRHluYW1pYzogYm9vbGVhbiwgbGluZTogbnVtYmVyKSB7XG4gIGlmIChpc0R5bmFtaWMpIHtcbiAgICBpZiAoaXNRdW90ZWQpIHtcbiAgICAgIHJldHVybiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMSB8fCAocGFydHMubGVuZ3RoID09PSAyICYmIHBhcnRzWzFdLnR5cGUgPT09ICdUZXh0Tm9kZScgJiYgKHBhcnRzWzFdIGFzIEFTVC5UZXh0Tm9kZSkuY2hhcnMgPT09ICcvJykpIHtcbiAgICAgICAgcmV0dXJuIHBhcnRzWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAgIGBBbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUgbXVzdCBiZSBhIHN0cmluZyBvciBhIG11c3RhY2hlLCBgICtcbiAgICAgICAgICBgcHJlY2VlZGVkIGJ5IHdoaXRlc3BhY2Ugb3IgYSAnPScgY2hhcmFjdGVyLCBhbmQgYCArXG4gICAgICAgICAgYGZvbGxvd2VkIGJ5IHdoaXRlc3BhY2UsIGEgJz4nIGNoYXJhY3Rlciwgb3IgJy8+JyAob24gbGluZSAke2xpbmV9KWAsXG4gICAgICAgICAgYi5sb2MobGluZSwgMClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA+IDAgPyBwYXJ0c1swXSA6IGIudGV4dChcIlwiKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcGFydDogQVNULkJhc2VOb2RlID0gcGFydHNbaV07XG5cbiAgICBpZiAocGFydC50eXBlICE9PSAnTXVzdGFjaGVTdGF0ZW1lbnQnICYmIHBhcnQudHlwZSAhPT0gJ1RleHROb2RlJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFwiVW5zdXBwb3J0ZWQgbm9kZSBpbiBxdW90ZWQgYXR0cmlidXRlIHZhbHVlOiBcIiArIHBhcnRbJ3R5cGUnXSwgcGFydC5sb2MpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBiLmNvbmNhdChwYXJ0cyk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlRW5kVGFnKHRhZzogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4sIGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSwgc2VsZkNsb3Npbmc6IGJvb2xlYW4pIHtcbiAgbGV0IGVycm9yO1xuXG4gIGlmICh2b2lkTWFwW3RhZy5uYW1lXSAmJiAhc2VsZkNsb3NpbmcpIHtcbiAgICAvLyBFbmdUYWcgaXMgYWxzbyBjYWxsZWQgYnkgU3RhcnRUYWcgZm9yIHZvaWQgYW5kIHNlbGYtY2xvc2luZyB0YWdzIChpLmUuXG4gICAgLy8gPGlucHV0PiBvciA8YnIgLz4sIHNvIHdlIG5lZWQgdG8gY2hlY2sgZm9yIHRoYXQgaGVyZS4gT3RoZXJ3aXNlLCB3ZSB3b3VsZFxuICAgIC8vIHRocm93IGFuIGVycm9yIGZvciB0aG9zZSBjYXNlcy5cbiAgICBlcnJvciA9IFwiSW52YWxpZCBlbmQgdGFnIFwiICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgXCIgKHZvaWQgZWxlbWVudHMgY2Fubm90IGhhdmUgZW5kIHRhZ3MpLlwiO1xuICB9IGVsc2UgaWYgKGVsZW1lbnQudGFnID09PSB1bmRlZmluZWQpIHtcbiAgICBlcnJvciA9IFwiQ2xvc2luZyB0YWcgXCIgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyBcIiB3aXRob3V0IGFuIG9wZW4gdGFnLlwiO1xuICB9IGVsc2UgaWYgKGVsZW1lbnQudGFnICE9PSB0YWcubmFtZSkge1xuICAgIGVycm9yID0gXCJDbG9zaW5nIHRhZyBcIiArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArIFwiIGRpZCBub3QgbWF0Y2ggbGFzdCBvcGVuIHRhZyBgXCIgKyBlbGVtZW50LnRhZyArIFwiYCAob24gbGluZSBcIiArXG4gICAgICAgICAgICBlbGVtZW50LmxvYy5zdGFydC5saW5lICsgXCIpLlwiO1xuICB9XG5cbiAgaWYgKGVycm9yKSB7IHRocm93IG5ldyBTeW50YXhFcnJvcihlcnJvciwgZWxlbWVudC5sb2MpOyB9XG59XG5cbmZ1bmN0aW9uIGZvcm1hdEVuZFRhZ0luZm8odGFnOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPikge1xuICByZXR1cm4gXCJgXCIgKyB0YWcubmFtZSArIFwiYCAob24gbGluZSBcIiArIHRhZy5sb2MuZW5kLmxpbmUgKyBcIilcIjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTeW50YXgge1xuICBwYXJzZTogdHlwZW9mIHByZXByb2Nlc3M7XG4gIGJ1aWxkZXJzOiB0eXBlb2YgYnVpbGRlcnM7XG4gIHByaW50OiB0eXBlb2YgcHJpbnQ7XG4gIHRyYXZlcnNlOiB0eXBlb2YgdHJhdmVyc2U7XG4gIFdhbGtlcjogdHlwZW9mIFdhbGtlcjtcbn1cblxuZXhwb3J0IGNvbnN0IHN5bnRheDogU3ludGF4ID0ge1xuICBwYXJzZTogcHJlcHJvY2VzcyxcbiAgYnVpbGRlcnMsXG4gIHByaW50LFxuICB0cmF2ZXJzZSxcbiAgV2Fsa2VyXG59O1xuXG4vKipcbiAgQVNUUGx1Z2lucyBjYW4gbWFrZSBjaGFuZ2VzIHRvIHRoZSBHbGltbWVyIHRlbXBsYXRlIEFTVCBiZWZvcmVcbiAgY29tcGlsYXRpb24gYmVnaW5zLlxuKi9cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luQnVpbGRlciB7XG4gIChlbnY6IEFTVFBsdWdpbkVudmlyb25tZW50KTogQVNUUGx1Z2luO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbiB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3I7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luRW52aXJvbm1lbnQge1xuICBtZXRhPzogYW55O1xuICBzeW50YXg6IFN5bnRheDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcmVwcm9jZXNzT3B0aW9ucyB7XG4gIHBsdWdpbnM/OiB7XG4gICAgYXN0PzogQVNUUGx1Z2luQnVpbGRlcltdO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcHJvY2VzcyhodG1sOiBzdHJpbmcsIG9wdGlvbnM/OiBQcmVwcm9jZXNzT3B0aW9ucyk6IEFTVC5Qcm9ncmFtIHtcbiAgbGV0IGFzdCA9ICh0eXBlb2YgaHRtbCA9PT0gJ29iamVjdCcpID8gaHRtbCA6IGhhbmRsZWJhcnMucGFyc2UoaHRtbCk7XG4gIGxldCBwcm9ncmFtID0gbmV3IFRva2VuaXplckV2ZW50SGFuZGxlcnMoaHRtbCwgb3B0aW9ucykuYWNjZXB0Tm9kZShhc3QpO1xuXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGx1Z2lucyAmJiBvcHRpb25zLnBsdWdpbnMuYXN0KSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBvcHRpb25zLnBsdWdpbnMuYXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgbGV0IHRyYW5zZm9ybSA9IG9wdGlvbnMucGx1Z2lucy5hc3RbaV07XG4gICAgICBsZXQgZW52ID0gYXNzaWduKHt9LCBvcHRpb25zLCB7IHN5bnRheCB9LCB7IHBsdWdpbnM6IHVuZGVmaW5lZCB9KTtcblxuICAgICAgbGV0IHBsdWdpblJlc3VsdCA9IHRyYW5zZm9ybShlbnYpO1xuXG4gICAgICB0cmF2ZXJzZShwcm9ncmFtLCBwbHVnaW5SZXN1bHQudmlzaXRvcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHByb2dyYW07XG59XG4iXX0=