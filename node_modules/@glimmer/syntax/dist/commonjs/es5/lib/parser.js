"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.Parser = undefined;

var _simpleHtmlTokenizer = require("simple-html-tokenizer");

var _util = require("@glimmer/util");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var entityParser = new _simpleHtmlTokenizer.EntityParser(_simpleHtmlTokenizer.HTML5NamedCharRefs);
var Parser = exports.Parser = function () {
    function Parser(source) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        _classCallCheck(this, Parser);

        this.elementStack = [];
        this.currentAttribute = null;
        this.currentNode = null;
        this.tokenizer = new _simpleHtmlTokenizer.EventedTokenizer(this, entityParser);
        this.options = options;
        this.tokenizer['states'].tagOpen = function () {
            var char = this.consume();
            if (char === "!") {
                this.state = 'markupDeclaration';
            } else if (char === "/") {
                this.state = 'endTagOpen';
            } else if (/[A-Za-z]/.test(char)) {
                this.state = 'tagName';
                this.delegate.beginStartTag();
                this.delegate.appendToTagName(char);
            }
        };
        this.tokenizer['states'].endTagOpen = function () {
            var char = this.consume();
            if (/[A-Za-z]/.test(char)) {
                this.state = 'tagName';
                this.delegate.beginEndTag();
                this.delegate.appendToTagName(char);
            }
        };
        this.source = source.split(/(?:\r\n?|\n)/g);
    }

    Parser.prototype.acceptNode = function acceptNode(node) {
        return this[node.type](node);
    };

    Parser.prototype.currentElement = function currentElement() {
        return this.elementStack[this.elementStack.length - 1];
    };

    Parser.prototype.sourceForNode = function sourceForNode(node, endNode) {
        var firstLine = node.loc.start.line - 1;
        var currentLine = firstLine - 1;
        var firstColumn = node.loc.start.column;
        var string = [];
        var line = void 0;
        var lastLine = void 0;
        var lastColumn = void 0;
        if (endNode) {
            lastLine = endNode.loc.end.line - 1;
            lastColumn = endNode.loc.end.column;
        } else {
            lastLine = node.loc.end.line - 1;
            lastColumn = node.loc.end.column;
        }
        while (currentLine < lastLine) {
            currentLine++;
            line = this.source[currentLine];
            if (currentLine === firstLine) {
                if (firstLine === lastLine) {
                    string.push(line.slice(firstColumn, lastColumn));
                } else {
                    string.push(line.slice(firstColumn));
                }
            } else if (currentLine === lastLine) {
                string.push(line.slice(0, lastColumn));
            } else {
                string.push(line);
            }
        }
        return string.join('\n');
    };

    _createClass(Parser, [{
        key: 'currentAttr',
        get: function get() {
            return this.currentAttribute;
        }
    }, {
        key: 'currentTag',
        get: function get() {
            var node = this.currentNode;
            (0, _util.assert)(node && (node.type === 'StartTag' || node.type === 'EndTag'), 'expected tag');
            return node;
        }
    }, {
        key: 'currentStartTag',
        get: function get() {
            var node = this.currentNode;
            (0, _util.assert)(node && node.type === 'StartTag', 'expected start tag');
            return node;
        }
    }, {
        key: 'currentEndTag',
        get: function get() {
            var node = this.currentNode;
            (0, _util.assert)(node && node.type === 'EndTag', 'expected end tag');
            return node;
        }
    }, {
        key: 'currentComment',
        get: function get() {
            var node = this.currentNode;
            (0, _util.assert)(node && node.type === 'CommentStatement', 'expected a comment');
            return node;
        }
    }, {
        key: 'currentData',
        get: function get() {
            var node = this.currentNode;
            (0, _util.assert)(node && node.type === 'TextNode', 'expected a text node');
            return node;
        }
    }]);

    return Parser;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLEFBQU8sQUFDTCxBQUFnQixBQUNoQixBQUFZLEFBQ1osQUFBa0IsQUFBSSxBQUFhLEFBQ3BDLEFBQU0sQUFBdUIsQUFBQzs7QUFLL0IsQUFBTyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQUUsQUFBTSxBQUFlLEFBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUUvQyxJQUFNLEFBQVksZUFBRyxBQUFJLEFBQVksQUFBQyxBQUFhLEFBQUMsQUFBQyxBQXdCckQsQUFBTTtJQVFKO29CQUFZLEFBQWMsUUFQaEI7WUFPa0IsOEVBQWtCLEFBQUU7Ozs7YUFQMUIsZUFBYyxBQUFFLEFBQUMsQUFHaEM7YUFBZ0IsbUJBQXNCLEFBQUksQUFBQyxBQUMzQzthQUFXLGNBQTZFLEFBQUksQUFBQyxBQUM3RjthQUFTLFlBQUcsQUFBSSxBQUFnQiwwQ0FBQyxBQUFJLE1BQUUsQUFBWSxBQUFDLEFBQUMsQUFHMUQsQUFBSTthQUFDLEFBQU8sVUFBRyxBQUFPLEFBQUMsQUFFdkIsQUFBSTthQUFDLEFBQVMsVUFBQyxBQUFRLEFBQUMsVUFBQyxBQUFPLFVBQUcsWUFDakM7Z0JBQUksQUFBSSxPQUFHLEFBQUksS0FBQyxBQUFPLEFBQUUsQUFBQyxBQUMxQixBQUFFLEFBQUM7Z0JBQUMsQUFBSSxTQUFLLEFBQUcsQUFBQyxLQUFDLEFBQUMsQUFDakIsQUFBSTtxQkFBQyxBQUFLLFFBQUcsQUFBbUIsQUFBQyxBQUNuQyxBQUFDLEFBQUMsQUFBSTt1QkFBSyxBQUFJLFNBQUssQUFBRyxBQUFDLEtBQUMsQUFBQyxBQUN4QixBQUFJO3FCQUFDLEFBQUssUUFBRyxBQUFZLEFBQUMsQUFDNUIsQUFBQyxBQUFDLEFBQUksQUFGQyxBQUFFLEFBQUM7bUJBRUgsQUFBRSxBQUFDLElB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LFFBQUksQUFBSSxLQUFDLEFBQUksU0FBSyxBQUFRLFVBQUUsQUFBa0IsQUFBQyxBQUFDLEFBQzNELEFBQU07bUJBQUMsQUFBcUIsQUFBQyxBQUMvQixBQUFDLEFBRUQsQUFBSSxBQUFjOzs7OzRCQUNoQjtnQkFBSSxBQUFJLE9BQUcsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUM1QixBQUFNOzhCQUFDLEFBQUksUUFBSSxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQWtCLG9CQUFFLEFBQW9CLEFBQUMsQUFBQyxBQUN2RSxBQUFNO21CQUFDLEFBQTRCLEFBQUMsQUFDdEMsQUFBQyxBQUVELEFBQUksQUFBVzs7Ozs0QkFDYjtnQkFBSSxBQUFJLE9BQUcsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUM1QixBQUFNOzhCQUFDLEFBQUksUUFBSSxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQVUsWUFBRSxBQUFzQixBQUFDLEFBQUMsQUFDakUsQUFBTTttQkFBQyxBQUFvQixBQUFDLEFBRTlCLEFBQUMsQUFJRCxBQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRXZlbnRlZFRva2VuaXplcixcbiAgRW50aXR5UGFyc2VyLFxuICBIVE1MNU5hbWVkQ2hhclJlZnMgYXMgbmFtZWRDaGFyUmVmc1xufSBmcm9tIFwic2ltcGxlLWh0bWwtdG9rZW5pemVyXCI7XG5pbXBvcnQgeyBQcm9ncmFtIH0gZnJvbSBcIi4vdHlwZXMvbm9kZXNcIjtcbmltcG9ydCAqIGFzIEFTVCBmcm9tIFwiLi90eXBlcy9ub2Rlc1wiO1xuaW1wb3J0ICogYXMgSGFuZGxlYmFyc0FTVCBmcm9tICcuL3R5cGVzL2hhbmRsZWJhcnMtYXN0JztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYXNzZXJ0LCBleHBlY3QgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcblxuY29uc3QgZW50aXR5UGFyc2VyID0gbmV3IEVudGl0eVBhcnNlcihuYW1lZENoYXJSZWZzKTtcblxuZXhwb3J0IHR5cGUgRWxlbWVudCA9IEFTVC5Qcm9ncmFtIHwgQVNULkVsZW1lbnROb2RlO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhZzxUIGV4dGVuZHMgJ1N0YXJ0VGFnJyB8ICdFbmRUYWcnPiB7XG4gIHR5cGU6IFQ7XG4gIG5hbWU6IHN0cmluZztcbiAgYXR0cmlidXRlczogYW55W107XG4gIG1vZGlmaWVyczogYW55W107XG4gIGNvbW1lbnRzOiBhbnlbXTtcbiAgc2VsZkNsb3Npbmc6IGJvb2xlYW47XG4gIGxvYzogQVNULlNvdXJjZUxvY2F0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0ZSB7XG4gIG5hbWU6IHN0cmluZztcbiAgcGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW107XG4gIGlzUXVvdGVkOiBib29sZWFuO1xuICBpc0R5bmFtaWM6IGJvb2xlYW47XG4gIHN0YXJ0OiBBU1QuUG9zaXRpb247XG4gIHZhbHVlU3RhcnRMaW5lOiBudW1iZXI7XG4gIHZhbHVlU3RhcnRDb2x1bW46IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFBhcnNlciB7XG4gIHByb3RlY3RlZCBlbGVtZW50U3RhY2s6IEVsZW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIG9wdGlvbnM6IE9iamVjdDtcbiAgcHJpdmF0ZSBzb3VyY2U6IHN0cmluZ1tdO1xuICBwdWJsaWMgY3VycmVudEF0dHJpYnV0ZTogT3B0aW9uPEF0dHJpYnV0ZT4gPSBudWxsO1xuICBwdWJsaWMgY3VycmVudE5vZGU6IE9wdGlvbjxBU1QuQ29tbWVudFN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSB8IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+PiA9IG51bGw7XG4gIHB1YmxpYyB0b2tlbml6ZXIgPSBuZXcgRXZlbnRlZFRva2VuaXplcih0aGlzLCBlbnRpdHlQYXJzZXIpO1xuXG4gIGNvbnN0cnVjdG9yKHNvdXJjZTogc3RyaW5nLCBvcHRpb25zOiBPYmplY3QgPSB7fSkge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnRva2VuaXplclsnc3RhdGVzJ10udGFnT3BlbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgbGV0IGNoYXIgPSB0aGlzLmNvbnN1bWUoKTtcbiAgICAgIGlmIChjaGFyID09PSBcIiFcIikge1xuICAgICAgICB0aGlzLnN0YXRlID0gJ21hcmt1cERlY2xhcmF0aW9uJztcbiAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gXCIvXCIpIHtcbiAgICAgICAgdGhpcy5zdGF0ZSA9ICdlbmRUYWdPcGVuJztcbiAgICAgIH0gZWxzZSBpZiAoL1tBLVphLXpdLy50ZXN0KGNoYXIpKSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSAndGFnTmFtZSc7XG4gICAgICAgIHRoaXMuZGVsZWdhdGUuYmVnaW5TdGFydFRhZygpO1xuICAgICAgICB0aGlzLmRlbGVnYXRlLmFwcGVuZFRvVGFnTmFtZShjaGFyKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy50b2tlbml6ZXJbJ3N0YXRlcyddLmVuZFRhZ09wZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgY2hhciA9IHRoaXMuY29uc3VtZSgpO1xuICAgICAgaWYgKC9bQS1aYS16XS8udGVzdChjaGFyKSkge1xuICAgICAgICB0aGlzLnN0YXRlID0gJ3RhZ05hbWUnO1xuICAgICAgICB0aGlzLmRlbGVnYXRlLmJlZ2luRW5kVGFnKCk7XG4gICAgICAgIHRoaXMuZGVsZWdhdGUuYXBwZW5kVG9UYWdOYW1lKGNoYXIpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZS5zcGxpdCgvKD86XFxyXFxuP3xcXG4pL2cpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRBdHRyKCk6IEF0dHJpYnV0ZSB7XG4gICAgcmV0dXJuIGV4cGVjdCh0aGlzLmN1cnJlbnRBdHRyaWJ1dGUsICdleHBlY3RlZCBhdHRyaWJ1dGUnKTtcbiAgfVxuXG4gIGdldCBjdXJyZW50VGFnKCk6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+IHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgKG5vZGUudHlwZSA9PT0gJ1N0YXJ0VGFnJyB8fCBub2RlLnR5cGUgPT09ICdFbmRUYWcnKSwgJ2V4cGVjdGVkIHRhZycpO1xuICAgIHJldHVybiBub2RlIGFzIFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+O1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRTdGFydFRhZygpOiBUYWc8J1N0YXJ0VGFnJz4ge1xuICAgIGxldCBub2RlID0gdGhpcy5jdXJyZW50Tm9kZTtcbiAgICBhc3NlcnQobm9kZSAmJiBub2RlLnR5cGUgPT09ICdTdGFydFRhZycsICdleHBlY3RlZCBzdGFydCB0YWcnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBUYWc8J1N0YXJ0VGFnJz47XG4gIH1cblxuICBnZXQgY3VycmVudEVuZFRhZygpOiBUYWc8J0VuZFRhZyc+IHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnRW5kVGFnJywgJ2V4cGVjdGVkIGVuZCB0YWcnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBUYWc8J0VuZFRhZyc+O1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRDb21tZW50KCk6IEFTVC5Db21tZW50U3RhdGVtZW50IHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnQ29tbWVudFN0YXRlbWVudCcsICdleHBlY3RlZCBhIGNvbW1lbnQnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBBU1QuQ29tbWVudFN0YXRlbWVudDtcbiAgfVxuXG4gIGdldCBjdXJyZW50RGF0YSgpOiBBU1QuVGV4dE5vZGUge1xuICAgIGxldCBub2RlID0gdGhpcy5jdXJyZW50Tm9kZTtcbiAgICBhc3NlcnQobm9kZSAmJiBub2RlLnR5cGUgPT09ICdUZXh0Tm9kZScsICdleHBlY3RlZCBhIHRleHQgbm9kZScpO1xuICAgIHJldHVybiBub2RlIGFzIEFTVC5UZXh0Tm9kZTtcblxuICB9XG5cbiAgYWNjZXB0Tm9kZShub2RlOiBIYW5kbGViYXJzQVNULlByb2dyYW0pOiBQcm9ncmFtO1xuICBhY2NlcHROb2RlPFUgZXh0ZW5kcyBBU1QuTm9kZT4obm9kZTogSGFuZGxlYmFyc0FTVC5Ob2RlKTogVTtcbiAgYWNjZXB0Tm9kZShub2RlOiBIYW5kbGViYXJzQVNULk5vZGUpOiBhbnkge1xuICAgIHJldHVybiB0aGlzW25vZGUudHlwZV0obm9kZSk7XG4gIH1cblxuICBjdXJyZW50RWxlbWVudCgpOiBFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50U3RhY2tbdGhpcy5lbGVtZW50U3RhY2subGVuZ3RoIC0gMV07XG4gIH1cblxuICBzb3VyY2VGb3JOb2RlKG5vZGU6IEhhbmRsZWJhcnNBU1QuTm9kZSwgZW5kTm9kZT86IHsgbG9jOiBIYW5kbGViYXJzQVNULlNvdXJjZUxvY2F0aW9uIH0pOiBzdHJpbmcge1xuICAgIGxldCBmaXJzdExpbmUgPSBub2RlLmxvYy5zdGFydC5saW5lIC0gMTtcbiAgICBsZXQgY3VycmVudExpbmUgPSBmaXJzdExpbmUgLSAxO1xuICAgIGxldCBmaXJzdENvbHVtbiA9IG5vZGUubG9jLnN0YXJ0LmNvbHVtbjtcbiAgICBsZXQgc3RyaW5nID0gW107XG4gICAgbGV0IGxpbmU7XG5cbiAgICBsZXQgbGFzdExpbmU6IG51bWJlcjtcbiAgICBsZXQgbGFzdENvbHVtbjogbnVtYmVyO1xuXG4gICAgaWYgKGVuZE5vZGUpIHtcbiAgICAgIGxhc3RMaW5lID0gZW5kTm9kZS5sb2MuZW5kLmxpbmUgLSAxO1xuICAgICAgbGFzdENvbHVtbiA9IGVuZE5vZGUubG9jLmVuZC5jb2x1bW47XG4gICAgfSBlbHNlIHtcbiAgICAgIGxhc3RMaW5lID0gbm9kZS5sb2MuZW5kLmxpbmUgLSAxO1xuICAgICAgbGFzdENvbHVtbiA9IG5vZGUubG9jLmVuZC5jb2x1bW47XG4gICAgfVxuXG4gICAgd2hpbGUgKGN1cnJlbnRMaW5lIDwgbGFzdExpbmUpIHtcbiAgICAgIGN1cnJlbnRMaW5lKys7XG4gICAgICBsaW5lID0gdGhpcy5zb3VyY2VbY3VycmVudExpbmVdO1xuXG4gICAgICBpZiAoY3VycmVudExpbmUgPT09IGZpcnN0TGluZSkge1xuICAgICAgICBpZiAoZmlyc3RMaW5lID09PSBsYXN0TGluZSkge1xuICAgICAgICAgIHN0cmluZy5wdXNoKGxpbmUuc2xpY2UoZmlyc3RDb2x1bW4sIGxhc3RDb2x1bW4pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzdHJpbmcucHVzaChsaW5lLnNsaWNlKGZpcnN0Q29sdW1uKSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudExpbmUgPT09IGxhc3RMaW5lKSB7XG4gICAgICAgIHN0cmluZy5wdXNoKGxpbmUuc2xpY2UoMCwgbGFzdENvbHVtbikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RyaW5nLnB1c2gobGluZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0cmluZy5qb2luKCdcXG4nKTtcbiAgfVxufVxuIl19